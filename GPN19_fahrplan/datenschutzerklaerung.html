<html>

<head>
	<meta charset="UTF-8">
	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	<link href="open-iconic/font/css/open-iconic-bootstrap.css" rel="stylesheet">
	<link href="style.css" rel="stylesheet">


	<script src="popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
	<script src="bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
	<script src="jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
	<script src="jquery.cookie@1.4.1/jquery.cookie.min.js"></script>
	<script src="mustache.min.js"></script>
	<script src="sugar2.0.4.js"></script>
	


	  <script  id="news_template" type="x-tmpl-mustache">

	  <div class="card text-center headercard">
	  <div class="card-body">
	  <h2 class="card-title">{{roomname}}</h2>
	  </div>
	  </div>
	  {{#items}}

	  <div class="card bordercolor cardhidden-{{hidden}} {{fav}}" id="id{{id}}">
	  <div class="card-body" style="position:relative">
	  <a href="{{url}}"><h5 class="card-title title {{fav}}-title" id="titleid{{id}}">{{title}}</h5></a>
	  <h6 class="card-subtitle mb-2 author">{{author}}</h6>
	  <!--p class="card-text">{{room}}</p-->
		<p class="card-text datecolor">{{datestring}}</p>
	  <p class="card-text"><small>{{abstract}} ({{lang}})</small></p>
	  <!--p class="card-text"><small class="text-muted">Track: {{track}}</small></p-->
		<p class="card-text oi oi-star favbar {{fav}}-title" id="starid{{id}}" style="position:absolute; right: 5px; top: 5px" onclick="like({{id}});"></p>
	  <p class="card-text timeto {{when}}" id="timeto{{id}}"><small id="txt{{id}}">{{txt}} </small><b id="hours{{id}}"> {{hours}}</b>h <b id="mins{{id}}">{{mins}}</b>mins</p>
	  </div>
	  </div>

	  {{/items}}
	  </script>
</head>

<body>

  <div class="card-group">
    <div class="card-column" style="width: 25%;">

    </div>
    <div class="card-column" style="width: 50%;">
	<div class="card bordercolor">
  		<div class="card-body" style="position:relative">
  			<a href="{{url}}"><h5 class="card-title title">Datenschutzerklaerung</h5></a>
  			<h6 class="card-subtitle mb-2 author">Cookies</h6>
  			<p class="card-text">Wir verwenden Cookies um Favoriten lokal auf Ihrem Rechner zu speichern. Keines der Cookies wird jemals an unseren Server übertragen. Die Cookies laufen spätestens am 5.Juni 2019 ab. Also einige Tage nach der GPN19.</p>
			<h6 class="card-subtitle mb-2 author">Tracking und Logs</h6>
  			<p class="card-text">Wir verwenden kein Trackingsystem und speichern keine Logs ihrer Zugriffe auf unsere Server. Bitte beachten Sie die Datenschutzerklärung der von uns verwendeten Bibliotheken:
			<ul>
				<li>Bootstrap4.1.3</li>
				<li>JQuery-3.3.1</li>
				<li>JQuery.cookie1.4.1</li>
				<li>Mustache3.0.1</li>
				<li>Popper1.14.3</li>
				<li>Sugar2.0.4</li>
				
			</ul></p>
 	 	</div>	
  	</div>

	<div class="card bordercolor">
  		<div class="card-body" style="position:relative">
  			<a href="{{url}}"><h5 class="card-title title">Impressum</h5></a>
  			<h6 class="card-subtitle mb-2 author">Angaben gemäß § 5 TMG:</h6>
  			<p class="card-text">Maximilian Noppel<br>Essenweinstraße 36a<br>76131 Karlsruhe</p>
			<h6 class="card-subtitle mb-2 author">Links:</h6>
			<p class="card-text">Die von mir verlinkten Seiten wurden nach bestem Gewissen geprüft, dennoch übernehme ich keinerlei Verantwortung für deren Inhalte.</p>
			<h6 class="card-subtitle mb-2 author">Kontakt:</h6>
  			<p class="card-text">max@noppelmax.online</p>
 	 	</div>	
  	</div>
    </div>
    <div class="card-column" style="width: 25%;">

    </div>
  </div>
  <div>
    <p class="text-center">fahrplan_v1.2, MIT Licence Maximilian Noppel 2018-2019 | <a href="datenschutzerklaerung.html">Datenschutzerklearung</a> | <a href="datenschutzerklaerung.html">Impressum</a></p>
  </div>

  <script>

	items = [];
  itemsPerRoom = [];
  itemsPerRoom[0] = [];
  itemsPerRoom[1] = [];
  itemsPerRoom[2] = [];
  itemsPerRoom[3] = [];
  itemsPerRoom[4] = [];
	itemsPerRoom[5] = [];
	itemsPerRoom[6] = [];

  rooms = ["ZKM_Medientheater","HfG_Studio","ZKM_Vortragssaal","ZKM_OpenHUB","ZKM_AckerSpace","ZKM_CodeHUB","Lounge"];

	function like(id){
		var date = new Date("2019-06-04T00:00:00Z");
		if($.inArray(id,favs)!=-1){
			favs.pop(id);
			pushed = 0
			$.cookie('favs', JSON.stringify(favs), { expires: date });
		}else{
			favs.push(id);
			pushed = 1
			$.cookie('favs', JSON.stringify(favs), { expires: date });
		}

		$.each(itemsPerRoom, function(r){
			$.each(itemsPerRoom[r], function(i){
				if(itemsPerRoom[r][i].id == id){
					console.log("Found")
					if(pushed){
						console.log("fav")
						itemsPerRoom[r][i].fav = "fav";
						$("#id"+String(itemsPerRoom[r][i].id)).addClass("fav")
						$("#id"+String(itemsPerRoom[r][i].id)).removeClass("unfav")

						$("#titleid"+String(itemsPerRoom[r][i].id)).addClass("fav-title")
						$("#titleid"+String(itemsPerRoom[r][i].id)).removeClass("unfav-title")

						$("#starid"+String(itemsPerRoom[r][i].id)).removeClass("unfav-title")
						$("#starid"+String(itemsPerRoom[r][i].id)).addClass("fav-title")
					}else{
						console.log("unfav")
						itemsPerRoom[r][i].fav = "unfav";
						$("#id"+String(itemsPerRoom[r][i].id)).removeClass("fav")
						$("#id"+String(itemsPerRoom[r][i].id)).addClass("unfav")

						$("#titleid"+String(itemsPerRoom[r][i].id)).addClass("unfav-title")
						$("#titleid"+String(itemsPerRoom[r][i].id)).removeClass("fav-title")

						$("#starid"+String(itemsPerRoom[r][i].id)).removeClass("fav-title")
						$("#starid"+String(itemsPerRoom[r][i].id)).addClass("unfav-title")
					}
					return;
				}
			})
		})






	};

  function parseH( t ) {
    var d = new Date();
    var time = t.match( /(\d+)(?::(\d\d))?\s*(p?)/ );
    return parseInt( time[1]) + (time[3] ? 12 : 0);
  }

  function parseM( t ) {
    var d = new Date();
    var time = t.match( /(\d+)(?::(\d\d))?\s*(p?)/ );
    return parseInt( time[2]) || 0 ;
  }

  Number.prototype.pad = function(size) {
    var s = String(this);
    while (s.length < (size || 2)) {s = "0" + s;}
    return s;
  }

  $( document ).ready(function() {
		try {
			favs = JSON.parse($.cookie('favs'));
		} catch (e) {
			favs = []
		} finally {
			console.log("Favs"+favs)
		}

    i = 0
    $.getJSON("https://feeds.noppelmax.online/gpn19.json", function (data) {
			console.log(data)
      dat = new Date(Date.now());
      dat.setDate(dat.getDate());
      dat.setMinutes(dat.getMinutes() - 10);

      datNow = new Date(Date.now());

      $.each(data.schedule.conference.days, function(day){
        $.each(data.schedule.conference.days[day].rooms, function(room){
          $.each(data.schedule.conference.days[day].rooms[room], function(idx){
            itm = data.schedule.conference.days[day].rooms[room][idx]
            authors = ""
            $.each(itm.persons,function(p){
              if(authors != ""){
                authors += ", ";
              }
              authors = authors + itm.persons[p].public_name;
            })

            sdate = new Date(itm.date);
            edate = new Date(itm.date);
            durH = parseH(itm.duration);
            durM = parseM(itm.duration);
            edate.setHours(edate.getHours() + durH);
            edate.setMinutes(edate.getMinutes() + durM);
            //console.log(sdate.getFullYear());
            mins = 0;
            hours = 0;
            if(sdate >= new Date(Date.now())){
              indate = new Date(sdate - datNow);
              mins = ((indate.getDate()-1) * 24 * 60) + ((indate.getHours()-1) * 60) + indate.getMinutes();

            }else{
              indate = new Date(datNow - sdate);
              mins = -(((indate.getDate()-1) * 24 * 60) + ((indate.getHours()-1) * 60) + indate.getMinutes());
            }

            hours = (mins / 60);
            if(mins < 0){
              hours = Math.ceil(hours);
            }else{
              hours = Math.floor(hours);
            }
            mins = mins - (hours) * 60;
            rmins = mins;
            rhours = hours;

            if(mins < 0){
              rmins = -mins;
            }

            if(hours < 0){
              rhours = -hours;
            }
						console.log("Favs:"+favs)
						if($.inArray(itm.id,favs)!=-1){
							fav = "fav"
						}else{
							fav = "unfav"
						}

            item = {
              title: itm.title,
              link: "link",
              datestring: sdate.getDate() + "." + (sdate.getMonth()+1) + ", " + sdate.getHours().pad(2) + ":" + sdate.getMinutes().pad(2) + " bis " + edate.getHours().pad(2) + ":" + edate.getMinutes().pad(2),
              room: room,
              description: itm.description,
              abstract: itm.abstract,
              author: authors,
              date: sdate,
              track: itm.track,
              type: itm.type,
              url: itm.url,
              duration: itm.duration,
              end: edate,
              lang: itm.language,
              id: itm.id,
              hidden: false,
              mins: rmins,
              hours: rhours,
							fav: fav
            };

            if( hours < 0 || mins < 0){
              item.when = "past";
              item.txt = "running since";
            }else{
              item.when = "future";
              item.txt = "starts in";
            }

            items.push(item);
          });
        });
      });
      items.sort(function(a,b){
        return new Date(a.date) - new Date(b.date);
      })

			console.log(items)



      items = items.filter(function(el) { return el.date > dat; });
      //items = items.filter(function(el) { return el.date > new Date("2018-12-29T15:00:00+01:00"); });

      $.each(items, function(i){
        $.each(rooms, function(r){
          if(items[i].room == rooms[r]){
            itemsPerRoom[r].push(items[i]);
						console.log("pushed")
          }
        });
      });

      var template = $('#news_template').html();
      Mustache.parse(template);   // optional, speeds up future uses

      $.each(rooms,function(r){
        var rendered = Mustache.render(template, {"items": itemsPerRoom[r], "roomname":rooms[r]});
        $("#cards_"+rooms[r]).html(rendered);
      });
    });

    window.setInterval(function(){
      console.log("Refiltering...");

      dat = new Date(Date.now());
      dat.setDate(dat.getDate());
      dat.setMinutes(dat.getMinutes() - 10);

      datNow = new Date(Date.now());

      $.each(itemsPerRoom, function(r){
        $.each(itemsPerRoom[r], function(i){

          var mins = 0;
          var hours = 0;
          if(itemsPerRoom[r][i].date >= datNow){
            indate = new Date(itemsPerRoom[r][i].date - datNow);
            mins = ((indate.getDate()-1) * 24 * 60) + ((indate.getHours()-1) * 60) + indate.getMinutes();

            hours = (mins / 60);
            hours = Math.floor(hours);
            mins = mins - (hours) * 60;

            $("#mins"+String(itemsPerRoom[r][i].id)).text(""+mins);
            $("#hours"+String(itemsPerRoom[r][i].id)).text(""+hours);

          }else{

            indate = new Date(datNow - itemsPerRoom[r][i].date);
            console.log(indate);
            mins = ((indate.getDate()-1) * 24 * 60) + ((indate.getHours()-1) * 60) + indate.getMinutes();

            hours = (mins / 60);
            hours = Math.floor(hours);
            mins = mins - (hours) * 60;

            $("#timeto"+String(itemsPerRoom[r][i].id)).removeClass("future");
            $("#timeto"+String(itemsPerRoom[r][i].id)).addClass("past");

            $("#txt"+String(itemsPerRoom[r][i].id)).text("running since ");

            $("#mins"+String(itemsPerRoom[r][i].id)).text(""+mins);
            $("#hours"+String(itemsPerRoom[r][i].id)).text(""+hours);
          }

          if((itemsPerRoom[r][i].date < dat)){
            $("#id"+String(itemsPerRoom[r][i].id)).fadeTo("slow", 0.01, function(){ //fade
              $(this).slideUp("slow", function() { //slide up
                $(this).remove(); //then remove from the DOM
              });
            });

          }
        });
      });
    },5000);
  });




  </script>
  <script>
  /*
  speed = 30
  function pageScroll() {
  window.scrollBy(0,1);
  scrolldelay = setTimeout(pageScroll,speed);
}
setTimeout(pageScroll,4000);
*/
</script>

</body>

</html>
